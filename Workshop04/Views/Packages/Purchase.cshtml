@model Workshop04.ViewModels.PurchasePackageViewModel

@{
    ViewData["Title"] = "Purchase Package";
}

<div class="container mt-4">
    <h1 class="mb-4">Purchase Travel Package</h1>

    <div class="row">
        <div class="col-md-8">
            <!-- Package Details Card -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary">
                    <h5 class="mb-0 text-white">Package Details</h5>
                </div>
                <div class="card-body">
                    <h3>@Model.Package?.PkgName</h3>

                    @if (Model.Package?.PkgStartDate.HasValue == true && Model.Package?.PkgEndDate.HasValue == true)
                    {
                        <p class="text-muted">
                            <i class="bi bi-calendar-range"></i>
                            <strong>Travel Dates:</strong>
                            @Model.Package.PkgStartDate.Value.ToString("MMMM dd, yyyy") -
                            @Model.Package.PkgEndDate.Value.ToString("MMMM dd, yyyy")
                        </p>
                    }

                    @if (!string.IsNullOrEmpty(Model.Package?.PkgDesc))
                    {
                        <p>@Model.Package.PkgDesc</p>
                    }

                    @if (Model.Package?.PackagesProductsSuppliers != null && Model.Package.PackagesProductsSuppliers.Any())
                    {
                        <div class="mt-3">
                            <h6>Package Includes:</h6>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product/Service</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var pps in Model.Package.PackagesProductsSuppliers)
                                    {
                                        @if (pps.ProductsSupplier?.Product != null)
                                        {
                                            <tr>
                                                <td>
                                                    <i class="bi bi-check-circle text-success"></i>
                                                    @pps.ProductsSupplier.Product.ProdName
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Price per person:</strong></p>
                                <p class="fs-5 text-primary mb-0">$@Model.Package?.PkgBasePrice.ToString("N2")</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <div class="card shadow-sm">
                <div class="card-header bg-success">
                    <h5 class="mb-0 text-white">Payment Information</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Purchase" method="post" id="purchaseForm">
                        <input type="hidden" asp-for="PackageId" />
                        <input type="hidden" asp-for="CustomerId" />
                        <input type="hidden" asp-for="TotalAmount" id="totalAmountHidden" />

                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <!-- Virtual Wallet Display -->
                        <div class="alert alert-info">
                            <h6><i class="bi bi-wallet2"></i> Your Virtual Wallet</h6>
                            <p class="mb-0">
                                <strong>Available Credit:</strong>
                                <span class="fs-5">$@Model.AvailableCredit.ToString("N2")</span>
                            </p>
                        </div>

                        <!-- Number of Travelers -->
                        <div class="mb-4">
                            <label asp-for="NumberOfTravelers" class="form-label fw-bold">
                                <i class="bi bi-people"></i> Number of Travelers
                            </label>
                            <select asp-for="NumberOfTravelers" class="form-select" id="numberOfTravelers">
                                @for (int i = 1; i <= 20; i++)
                                {
                                    <option value="@i">@i @(i == 1 ? "Traveler" : "Travelers")</option>
                                }
                            </select>
                            <span asp-validation-for="NumberOfTravelers" class="text-danger"></span>
                            <small class="form-text text-muted">Select the number of people traveling</small>
                        </div>

                        <!-- Price Breakdown -->
                        <div class="card mb-3 bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Price Breakdown</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Price per person:</span>
                                    <span class="fw-bold">$@Model.Package?.PkgBasePrice.ToString("N2")</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Number of travelers:</span>
                                    <span class="fw-bold" id="travelersDisplay">@Model.NumberOfTravelers</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span class="fs-5"><strong>Total Price:</strong></span>
                                    <span class="fs-4 text-primary fw-bold" id="totalPrice">
                                        $@((Model.Package?.PkgBasePrice ?? 0 * Model.NumberOfTravelers).ToString("N2"))
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div id="sufficientCreditSection" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Balance After Purchase:</label>
                                <div class="fs-5 text-success" id="balanceAfter">
                                    $0.00
                                </div>
                            </div>

                            <div class="form-check mb-3">
                                <input asp-for="ConfirmPurchase" class="form-check-input me-2" type="checkbox" id="ConfirmPurchase" />
                                <label for="ConfirmPurchase" class="form-check-label text-black">
                                    I confirm that I want to purchase this package for <span id="confirmPrice" class="fw-bold">$0.00</span>
                                </label>
                                <span asp-validation-for="ConfirmPurchase" class="text-danger d-block"></span>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg mt-2">
                                    <i class="bi bi-credit-card"></i> Complete Purchase
                                </button>
                                <a asp-action="Index" class="btn btn-outline-secondary">
                                    Cancel
                                </a>
                            </div>
                        </div>

                        <div id="insufficientCreditSection" style="display: none;">
                            <div class="alert alert-danger">
                                <h6><i class="bi bi-exclamation-triangle"></i> Insufficient Credit</h6>
                                <p>
                                    You need <strong id="neededAmount">$0.00</strong> but only have
                                    <strong>$@Model.AvailableCredit.ToString("N2")</strong> in your wallet.
                                </p>
                                <p class="mb-0">
                                    Please contact customer service to add credit to your account.
                                </p>
                            </div>
                            <div class="d-grid gap-2">
                                <a asp-action="Index" class="btn btn-secondary">
                                    Back to Packages
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Customer Info Sidebar -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary">
                    <h6 class="mb-0 text-white">Customer Information</h6>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong><br>@Model.Customer?.CustFirstName @Model.Customer?.CustLastName</p>
                    <p><strong>Email:</strong><br>@Model.Customer?.CustEmail</p>
                    <p><strong>Phone:</strong><br>@Model.Customer?.CustHomePhone</p>
                </div>
            </div>

            <!-- Quick Summary -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-info">
                    <h6 class="mb-0 text-white"><i class="bi bi-info-circle"></i> Quick Summary</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Package:</strong><br>@Model.Package?.PkgName</p>
                    <p class="mb-2"><strong>Travelers:</strong><br><span id="sidebarTravelers">@Model.NumberOfTravelers</span></p>
                    <p class="mb-0"><strong>Total Cost:</strong><br><span id="sidebarTotal" class="fs-5 text-primary">$@((Model.Package?.PkgBasePrice ?? 0 * Model.NumberOfTravelers).ToString("N2"))</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const pricePerPerson = @Model.Package?.PkgBasePrice ?? 0;
        const availableCredit = @Model.AvailableCredit;

        function updatePricing() {
            const travelers = parseInt(document.getElementById('numberOfTravelers').value);
            const totalAmount = pricePerPerson * travelers;

            // Update all display elements
            document.getElementById('travelersDisplay').textContent = travelers;
            document.getElementById('totalPrice').textContent = '$' + totalAmount.toFixed(2);
            document.getElementById('sidebarTravelers').textContent = travelers;
            document.getElementById('sidebarTotal').textContent = '$' + totalAmount.toFixed(2);
            document.getElementById('totalAmountHidden').value = totalAmount.toFixed(2);
            document.getElementById('confirmPrice').textContent = '$' + totalAmount.toFixed(2);
            document.getElementById('neededAmount').textContent = '$' + totalAmount.toFixed(2);

            // Check if sufficient credit
            if (availableCredit >= totalAmount) {
                const balanceAfter = availableCredit - totalAmount;
                document.getElementById('balanceAfter').textContent = '$' + balanceAfter.toFixed(2);
                document.getElementById('sufficientCreditSection').style.display = 'block';
                document.getElementById('insufficientCreditSection').style.display = 'none';
            } else {
                document.getElementById('sufficientCreditSection').style.display = 'none';
                document.getElementById('insufficientCreditSection').style.display = 'block';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updatePricing();

            // Update when travelers changes
            document.getElementById('numberOfTravelers').addEventListener('change', updatePricing);
        });

        // Form submission validation
        document.getElementById('purchaseForm').addEventListener('submit', function(e) {
            const checkbox = document.getElementById('ConfirmPurchase');
            const travelers = parseInt(document.getElementById('numberOfTravelers').value);
            const totalAmount = pricePerPerson * travelers;

            if (availableCredit < totalAmount) {
                e.preventDefault();
                alert('Insufficient credit balance for this purchase.');
                return false;
            }

            if (!checkbox.checked) {
                e.preventDefault();
                alert('Please confirm your purchase by checking the box.');
                return false;
            }
            return true;
        });
    </script>
}